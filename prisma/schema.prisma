// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ตาราง Users - ผู้ใช้งานระบบ
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(50)
  email     String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  fullName  String?  @map("full_name") @db.VarChar(100)
  role      UserRole @default(USER)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  websites       UserWebsite[]
  emailAccounts  EmailAccount[]
  activityLogs   ActivityLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
}

// ตาราง Websites - เก็บข้อมูล websites ที่ดึงจาก Plesk
model Website {
  id          Int      @id @default(autoincrement())
  pleskDomainId Int    @unique @map("plesk_domain_id")
  domainName  String   @unique @map("domain_name") @db.VarChar(255)
  asciiName   String?  @map("ascii_name") @db.VarChar(255)
  hostingType String?  @map("hosting_type") @db.VarChar(50)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  userWebsites  UserWebsite[]
  emailAccounts EmailAccount[]

  @@map("websites")
}

// ตาราง UserWebsite - กำหนดสิทธิ์ user กับ website
model UserWebsite {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  websiteId Int      @map("website_id")
  canCreate Boolean  @default(true) @map("can_create")
  canDelete Boolean  @default(false) @map("can_delete")
  maxEmails Int      @default(10) @map("max_emails")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  website Website @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@unique([userId, websiteId])
  @@map("user_websites")
}

// ตาราง EmailAccounts - เก็บข้อมูลอีเมล์ที่สร้าง
model EmailAccount {
  id           Int      @id @default(autoincrement())
  emailAddress String   @unique @map("email_address") @db.VarChar(255)
  mailName     String   @map("mail_name") @db.VarChar(100)
  domainName   String   @map("domain_name") @db.VarChar(255)
  userId       Int      @map("user_id")
  websiteId    Int?     @map("website_id")
  hasMailbox   Boolean  @default(true) @map("has_mailbox")
  quotaMb      Int      @default(0) @map("quota_mb")
  isActive     Boolean  @default(true) @map("is_active")
  description  String?  @db.VarChar(255)
  // เก็บ password แบบ encrypted สำหรับ auto-login webmail
  encryptedPassword String? @map("encrypted_password") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  website Website? @relation(fields: [websiteId], references: [id], onDelete: SetNull)

  @@map("email_accounts")
}

// ตาราง ActivityLog - เก็บ log การทำงาน
model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  action    String   @db.VarChar(50)
  details   String?  @db.Text
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

// ตาราง AllowedDomain - โดเมนที่อนุญาตให้สร้างอีเมล์
model AllowedDomain {
  id         Int      @id @default(autoincrement())
  domainName String   @unique @map("domain_name") @db.VarChar(255)
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("allowed_domains")
}

// ตาราง SystemSettings - ตั้งค่าระบบ
model SystemSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}